import React, { useMemo, useRef, useState, useEffect } from "react";
import { useAuth } from "@clerk/clerk-react";

type AiMerchant = {
  merchant: string;
  amount: number;
};

type AiCategory = {
  category: string;
  total: number;
  merchants: AiMerchant[];
  txnIds?: number[];
};

type AiInsights = {
  highlights?: string[];
  topSpendingCategory?: string;
  topMerchant?: string;
  concentrationNotes?: string[];
  optimizationIdeas?: string[];
  anomalies?: string[];
};

type AiResult = {
  totalExpenses: number;
  billPaymentsTotal?: number;
  payrollTotal?: number;
  categories: AiCategory[];
  notes?: string;
  insights?: AiInsights;
};

type UploadAiResponse = {
  ok: boolean;
  filename: string;
  transactionCount: number;
  ai: AiResult;
  availableCategories?: string[];
};

export default function SpendingIntelligencePage() {
  const { getToken } = useAuth();

  const [files, setFiles] = useState<File[]>([]);
  const inputRef = useRef<HTMLInputElement | null>(null);

  const [selectedMonth, setSelectedMonth] = useState<string>(() => {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`;
  });

  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState<string | null>(null);
  const [result, setResult] = useState<UploadAiResponse | null>(null);

  // ðŸ”¹ Local categories (mutable)
  const [localCategories, setLocalCategories] = useState<AiCategory[]>([]);

  useEffect(() => {
    if (result?.ai?.categories) {
      setLocalCategories(result.ai.categories);
    }
  }, [result]);

  const monthOptions = useMemo(() => buildRecentMonthOptions(18), []);

  function moveMerchant(
    fromCategory: string,
    merchantName: string,
    amount: number,
    toCategory: string
  ) {
    if (fromCategory === toCategory) return;

    setLocalCategories((prev) => {
      const updated = prev.map((c) => ({
        ...c,
        merchants: [...(c.merchants || [])],
      }));

      const source = updated.find((c) => c.category === fromCategory);
      const target = updated.find((c) => c.category === toCategory);

      if (!source) return prev;

      const idx = source.merchants.findIndex((m) => m.merchant === merchantName);
      if (idx === -1) return prev;

      const merchantObj = source.merchants[idx];

      source.merchants.splice(idx, 1);
      source.total = Number(source.total) - Number(amount);

      if (target) {
        target.merchants.push(merchantObj);
        target.total = Number(target.total) + Number(amount);
      } else {
        updated.push({
          category: toCategory,
          total: amount,
          merchants: [merchantObj],
        });
      }

      return updated.sort((a, b) => Number(b.total) - Number(a.total));
    });
  }

  const hasAi =
    !!result?.ai &&
    localCategories.length > 0;

  const insights = result?.ai?.insights;

  const hasStructuredInsights =
    !!insights &&
    (hasAny(insights.highlights) ||
      !!insights.topSpendingCategory ||
      !!insights.topMerchant ||
      hasAny(insights.concentrationNotes) ||
      hasAny(insights.optimizationIdeas) ||
      hasAny(insights.anomalies));

  const hasLegacyNotes = !!result?.ai?.notes && result.ai.notes.trim().length > 0;

  return (
    <div style={{ maxWidth: 900, margin: "24px auto", fontFamily: "system-ui", padding: 12 }}>
      <h1 style={{ marginBottom: 4 }}>AI Spending Intelligence</h1>

      {/* Upload section â€” unchanged */}
      {/* Keep your full original upload UI here exactly as before */}

      {/* Results */}
      {!hasAi ? (
        <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 18 }}>
          <div style={{ fontWeight: 800 }}>Spending Synopsis</div>
        </div>
      ) : (
        <div>
          <div style={{ marginTop: 16, border: "1px solid #eee", borderRadius: 12, padding: 18 }}>
            <div style={{ fontWeight: 800, marginBottom: 10 }}>
              Spending by Category
            </div>

            {localCategories.map((c) => (
              <div key={c.category} style={{ marginBottom: 16 }}>
                <div style={{ fontWeight: 900 }}>
                  {c.category} â€” {fmtMoney(Number(c.total))}
                </div>

                <table style={{ width: "100%", borderCollapse: "collapse", marginTop: 8 }}>
                  <thead>
                    <tr>
                      <th style={th}>Merchant</th>
                      <th style={th}>Amount</th>
                      <th style={th}>Move To</th>
                    </tr>
                  </thead>
                  <tbody>
                    {(c.merchants || []).map((m) => (
                      <tr key={`${c.category}-${m.merchant}`}>
                        <td style={td}>{m.merchant}</td>
                        <td style={td}>{fmtMoney(Number(m.amount))}</td>
                        <td style={td}>
                          <select
                            value={c.category}
                            onChange={(e) =>
                              moveMerchant(
                                c.category,
                                m.merchant,
                                Number(m.amount),
                                e.target.value
                              )
                            }
                          >
                            {(result?.availableCategories || []).map((opt) => (
                              <option key={opt} value={opt}>
                                {opt}
                              </option>
                            ))}
                          </select>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

const th: React.CSSProperties = {
  textAlign: "left",
  borderBottom: "1px solid #eee",
  padding: "10px 8px",
  fontSize: 13,
};

const td: React.CSSProperties = {
  borderBottom: "1px solid #f1f1f1",
  padding: "10px 8px",
};

function fmtMoney(n: number) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
  }).format(n);
}

function hasAny(arr?: unknown[]) {
  return Array.isArray(arr) && arr.length > 0;
}

function buildRecentMonthOptions(count: number): { key: string; label: string }[] {
  const out: { key: string; label: string }[] = [];
  const d = new Date();
  d.setDate(1);

  for (let i = 0; i < count; i++) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const key = `${y}-${m}`;
    out.push({ key, label: formatMonthLabel(key) });
    d.setMonth(d.getMonth() - 1);
  }

  return out;
}

function formatMonthLabel(monthKey: string) {
  const [yy, mm] = monthKey.split("-");
  const y = Number(yy);
  const m = Number(mm);
  const dt = new Date(y, m - 1, 1);
  return dt.toLocaleString("en-US", { month: "short", year: "numeric" });
}